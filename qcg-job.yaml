tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - indigo_custom_types: https://raw.githubusercontent.com/indigo-dc/tosca-types/qcg_integration/custom_types.yaml


description: TOSCA example for submitting a job to a QCG

metadata:
  display_name: HPC Job
  tag: qcg

topology_template:

  inputs:

    docker_image:
      type: string
      default: deephdc/deep-oc-dogs_breed_det:cpu
      required: no
    run_command:
      type: string
      required: no
      default: 'deepaas-cli get_metadata'
    recreate_container:
      type: boolean
      default: false
      required: no
    udocker_extra_options:
      type: string
      required: no
      default: ''
    onedata_space_name:
      type: string
      required: yes
    onedata_mount_point:
      type: string
      required: no
      default: "/mnt/onedata"
    app_in_out_base_dir:
      type: string
      required: no
      default: ''
    std_outerr:
      type: string
      required: no
      default: 'log.txt'
    total_cores:
      type: integer
      required: no
      default: 2
    num_gpus:
      type: integer
      required: no
      default: 0
    total_nodes:
      type: integer
      required: no
      default: 1
    cores_per_node:
      type: integer
      required: no
      default: 2
    queue:
      type: string
      required: no
      default: standard
#    wall_clock:
#      type: float
#      required: no
#      default: 100

  node_templates:

    onedata_space:
      type: tosca.nodes.indigo.OnedataSpace
      properties:
        onezone: 'https://onezone-beta.cloud.ba.infn.it'
        space: { get_input: onedata_space_name }
        oneproviders: [ 'oneprovider-beta-2.cloud.ba.infn.it' ]

    qcg_job:
      type: tosca.nodes.indigo.Qcg.Job
      properties:
        note: "Script to submit a deep-oc application"
        #schema: "https://qcg-deep.apps.paas-dev.psnc.pl/api/schema/"
        executable: "curl -s https://raw.githubusercontent.com/deephdc/deep-hpc/qcg/deep-slurm-qcg.sh | bash"
        std_outerr: { get_input: std_outerr }
        directory: "${HOME}"
        total_cores: { get_input: total_cores }
        total_nodes: { get_input: total_nodes }
        cores_per_node: { get_input: cores_per_node }
        queue: { get_input: queue }
        #wall_clock: { get_input: wall_clock }
        environment:
          DOCKER_IMAGE: { get_input: docker_image }
          UDOCKER_RECREATE: { get_input: recreate_container }
          UDOCKER_EXTRA_OPTIONS: { get_input: udocker_extra_options }
          ONECLIENT_ACCESS_TOKEN: { get_attribute : [ onedata_space, token ] }
          ONECLIENT_PROVIDER_HOST: "oneprovider-beta-2.cloud.ba.infn.it"
          ONEDATA_MOUNT_POINT: { get_input: onedata_mount_point }
          UDOCKER_RUN_COMMAND: { get_input: run_command }
          APP_IN_OUT_BASE_DIR: { get_input: app_in_out_base_dir }
          NUM_GPUS: { get_input: num_gpus }